<body>
	<style>
		body {
			background: black;
			color: red;
			font-family: monospace;
			text-align: center;
			margin: 0;
			padding: 0;
			}
			canvas {
			background: black;
			display: block;
			margin: 40px auto;
			border: 3px solid red;
			box-shadow: 0 0 20px red;
		}
	</style>

	<!-- must be before script -->
	<canvas id="pong" width="800" height="400"></canvas>

	<script>
		// client
		const socket = new WebSocket("ws://localhost:3000");
		// events
		socket.onopen = () => {
			console.log("Connected to server");
		};
		socket.onmessage = (event) => {
			console.log("Message from server:", event.data);

			if (event.data === "2")
				update();

			if (event.data === "1")
				otherPaddle.dy = -speed;
			if (event.data === "0")
				otherPaddle.dy = speed;
	
		};
		socket.onclose = () => {
			console.log("Connection closed");
		};

		// me
		// GAME
		function drawLine(context, x1, y1, x2, y2, color = "white", width = 2) {
			context.beginPath();
			context.moveTo(x1, y1);
			context.lineTo(x2, y2);
			context.strokeStyle = color;
			context.lineWidth = width;
			context.stroke();
		}
		function drawCircle(context, x, y, radius, color = "white", fill = true, lineWidth = 2) {
			context.beginPath();
			context.arc(x, y, radius, 0, Math.PI * 2);
			if (fill) {
				context.fillStyle = color;
				context.fill();
			} else {
				context.strokeStyle = color;
				context.lineWidth = lineWidth;
				context.stroke();
			}
		}
		//

		const canvas = document.getElementById("pong");
		const context = canvas.getContext("2d");

		const scale = 1;

		const paddleWidth = 10 * scale;
		const paddleHeight = 100 * scale;
		const ballSize = 10 * scale;

		let otherPaddle = {
			x: 0, 
			y: canvas.height / 2 - paddleHeight / 2, 
			dy: 0 
		};
		let myPaddle = { 
			x: canvas.width - paddleWidth, 
			y: canvas.height / 2 - paddleHeight / 2, 
			dy: 0
		};
		let ball = { 
			x: canvas.width / 2, 
			y: canvas.height / 2, 
			dx: 4,
			dy: 4
		};

		const speed = 5;

		function draw() {
			context.clearRect(0, 0, canvas.width, canvas.height);
			context.fillStyle = "red"; 

			context.fillRect(otherPaddle.x, otherPaddle.y, paddleWidth, paddleHeight);
			context.fillRect(myPaddle.x, myPaddle.y, paddleWidth, paddleHeight);
			context.fillRect(ball.x, ball.y, ballSize, ballSize);

			const dashHeight = 15;
			const gap = 7;
			for (let y = 0; y < canvas.height; y += dashHeight + gap)
				drawLine(context, canvas.width / 2, y, canvas.width / 2, y + dashHeight, "red", 3);
			drawCircle(context, canvas.width / 2, canvas.height / 2, 60, "red", false, 3);
		}

		function movePaddles() {
			otherPaddle.y += otherPaddle.dy;
			myPaddle.y += myPaddle.dy;

			if (otherPaddle.y < 0) otherPaddle.y = 0;
			if (otherPaddle.y + paddleHeight > canvas.height) otherPaddle.y = canvas.height - paddleHeight;
			if (myPaddle.y < 0) myPaddle.y = 0;
			if (myPaddle.y + paddleHeight > canvas.height) myPaddle.y = canvas.height - paddleHeight;
		}

		function moveBall() {
			ball.x += ball.dx;
			ball.y += ball.dy;

			if (ball.y <= 0 || ball.y + ballSize >= canvas.height) {
				ball.dy = -ball.dy;
			}

			if (
				(ball.x <= otherPaddle.x + paddleWidth && ball.x >= otherPaddle.x &&
				ball.y + ballSize >= otherPaddle.y && ball.y <= otherPaddle.y + paddleHeight) ||
				(ball.x + ballSize >= myPaddle.x && ball.x + ballSize <= myPaddle.x + paddleWidth &&
				ball.y + ballSize >= myPaddle.y && ball.y <= myPaddle.y + paddleHeight)
			)
			{
				ball.dx = -ball.dx;
			}

			if (ball.x < 0 || ball.x > canvas.width) {

				// score
				if (ball.x < 0)
					console.log("1 point for right");
				else
					console.log("1 point for left");

				ball.x = canvas.width / 2;
				ball.y = canvas.height / 2;
				ball.dx = 4;
				ball.dy = 4;
			}
		}

		let counter = 0;

		function update() {
			movePaddles();
			moveBall();
			draw();

			counter++;
			// console.debug(`--- Game State ${counter} ---`);
			
			// for 60 fps
			// not working when tab is inactive
			// smooth animation

			requestAnimationFrame(update);
			// update();
		}

		document.addEventListener("keydown", (e) => {
			switch (e.key) {
				case "ArrowUp":
				{
					myPaddle.dy = -speed;
					socket.send("1");
					// socket.send(1); // send "1"
					// socket.send(Buffer.from([1])); // send nothing
					break;
				}
				case "ArrowDown":
				{
					myPaddle.dy = speed;
					socket.send("0");
					break;
				}
			}
		});

		// start
		// update();

	</script>

</body>
